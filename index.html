<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Вставка HTML-кода на сайте</title>
</head>
<body>
    <h1>Авторизация
========================================================================================
&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |   Пользователи.Логин КАК Логин,
        |   Пользователи.УникальныйИдентификатор КАК УникальныйИдентификатор
        |ИЗ
        |   Справочник.Пользователи КАК Пользователи
        |ГДЕ
        |   Пользователи.Логин = &Логин";
    
    Запрос.УстановитьПараметр("Логин", Объект.Логин);
    
    РезультатЗапроса = Запрос.Выполнить().Выбрать();
    
    Попытка
        ПользИБ = ПользователиИнформационнойБазы.СоздатьПользователя();
        ПользИБ.Имя = Объект.Логин;
        ПользИБ.Пароль = Объект.Пароль;
        ПользИБ.ПолноеИмя = Объект.Наименование;
        Если Объект.Роль = Перечисления.Роль.Админ Тогда
            ПользИБ.Роли.Добавить(Метаданные.Роли.Админ);
        Иначе
            ПользИБ.Роли.Добавить(Метаданные.Роли.Доставщик);
        КонецЕсли; 
        ПользИБ.Записать();
    Исключение
        Сообщить("Ошибка записи");
    КонецПопытки;
КонецПроцедуры
========================================================================================

Пользователи:
Логин
Пароль
УникальныйИдентификатор
Роль

Роли:




Мобилка
Мейн:

Доставка(НА Основании Заказа)
========================================================================================
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
    //{{__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
    // Данный фрагмент построен конструктором.
    // При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
    Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.Заказ") и ДанныеЗаполнения.Доставка = ИСТИНА Тогда
        // Заполнение шапки
        АдресДоставки = ДанныеЗаполнения.АдресДоставки;
        Клиент = ДанныеЗаполнения.Клиент;
        Заказ = ДанныеЗаполнения.Ссылка;
        СуммаЗаказа = ДанныеЗаполнения.Товары.Итог("Сумма");
        Для Каждого ТекСтрокаТовары Из ДанныеЗаполнения.Товары Цикл
            НоваяСтрока = Товары.Добавить();
            НоваяСтрока.Количество = ТекСтрокаТовары.Количество;
            НоваяСтрока.Товар = ТекСтрокаТовары.Товар;
        КонецЦикла;
    Иначе  
        ВызватьИсключение("Для " + ДанныеЗаполнения.Ссылка + " доставка не может быть назначена");
    КонецЕсли;
    //}}__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
    
    Если Доставлен = Истина Тогда
        
        ЗаказДоставки = ЭтотОбъект.Заказ.ПолучитьОбъект();
        ЗаказДоставки.Статус = Перечисления.СтатусыЗаказов.Закрыт;
        
    КонецЕсли;
    
КонецПроцедуры
========================================================================================

Заказ
========================================================================================
&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
    СтрокаТЧ = Элементы.Товары.ТекущиеДанные;
    СтрокаТЧ.Сумма = СтрокаТЧ.Количество * СтрокаТЧ.Цена;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
    СтрокаТЧ = Элементы.Товары.ТекущиеДанные;
    СтрокаТЧ.Сумма = СтрокаТЧ.Количество * СтрокаТЧ.Цена;
КонецПроцедуры

&НаКлиенте
Процедура УсловияДоставкиПриИзменении(Элемент)
    Если Объект.Доставка = Истина Тогда
        Элементы.АдресДоставки.Видимость = Истина;
    Иначе
        Элементы.АдресДоставки.Видимость = Ложь;
    КонецЕсли;
КонецПроцедуры
========================================================================================

Модуль Веб сервиса
========================================================================================
Функция PostData()
    
    ОтветСервера = Новый Структура();

    Попытка
        
            ЗапросДоставка = Новый Запрос;
            ЗапросДоставка.Текст = "ВЫБРАТЬ
                                   |    ДоставкаТовары.Товар.Наименование КАК Товар,
                                   |    ДоставкаТовары.Количество КАК Количество,
                                   |    ДоставкаТовары.Ссылка.Номер КАК Номер,
                                   |    ДоставкаТовары.Ссылка.Дата КАК Дата,
                                   |    ДоставкаТовары.Ссылка.Клиент.Наименование КАК Клиент,
                                   |    ДоставкаТовары.Ссылка.АдресДоставки КАК АдресДоставки,
                                   |    ДоставкаТовары.Ссылка.СуммаЗаказа КАК СуммаЗаказа,
                                   |    УНИКАЛЬНЫЙИДЕНТИФИКАТОР(ДоставкаТовары.Ссылка) КАК УИД
                                   |ИЗ
                                   |    Документ.Доставка.Товары КАК ДоставкаТовары
                                   |ГДЕ
                                   |    ДоставкаТовары.Ссылка.Проведен = ИСТИНА
                                   |    И ДоставкаТовары.Ссылка.Доставлен = ЛОЖЬ";
            ОтветСервера.Вставить("Ответ", ЗапросДоставка.Выполнить().Выгрузить());
            Возврат ОбменДанными.Сериализовать(ОтветСервера)
        
    Исключение
            ОтветСервера = Новый Структура("Ответ", ОписаниеОшибки());
        Возврат ОбменДанными.Сериализовать(ОтветСервера);
    КонецПопытки;
        
КонецФункции 

Функция GetData(GetData)
    
    ОтветСервера = Новый Структура;
    Если ЗначениеЗаполнено(GetData) Тогда
            ПолученныеДанные = ОбменДанными.Десериализовать(GetData);
    КонецЕсли;
    Попытка
        Доставка = Документы.Доставка.ПолучитьСсылку(ПолученныеДанные.Данные).ПолучитьОбъект();
        Доставка.Доставлен = ИСТИНА;
        Доставка.Записать(РежимЗаписиДокумента.Проведение);
        ОтветСервера.Вставить("Ответ", "Данные успешно доставлены");
        Возврат ОбменДанными.Сериализовать(ОтветСервера)
    Исключение
        ОтветСервера.Вставить("Ответ", ОписаниеОшибки());
        Возврат ОбменДанными.Сериализовать(ОтветСервера)
    КонецПопытки;
    

КонецФункции
========================================================================================

Клиенты:
КонтактныйТелефон
ЭлектроннаяПочта

Товары:

Заказы:
Клиент
Статус
Доставка
АдресДоставки
ТЧ:
Товар
Количество
Цена
Сумма

Доставка:
Клиент
АдресДоставки
СуммаЗаказа
Доставлен
Заказ
ТЧ:
Товар
Количество


Мобильная часть

Кнопка ПроверитьНовые
========================================================================================
&НаСервере
Процедура ПроверитьНовыеНаСервере()
    Попытка
            //обращение к веб-сервису
            Соединение = WSСсылки.Exchange.СоздатьWSПрокси("Exchange","Exchange","ExchangeSoap");
            ОтветСервера = Соединение.PostData();
            
            ОтветТЗ = Служебный.Десериализовать(ОтветСервера);
            
            //создание документов
            ЗапросОтветТЗ = Новый Запрос;
            ЗапросОтветТЗ.Текст = "ВЫБРАТЬ
                                  | ОтветТЗ.Товар КАК Товар,
                                  | ОтветТЗ.Количество КАК Количество,
                                  | ОтветТЗ.Номер КАК Номер,
                                  | ОтветТЗ.Дата КАК Дата,
                                  | ОтветТЗ.Клиент КАК Клиент,
                                  | ОтветТЗ.АдресДоставки КАК АдресДоставки,
                                  | ОтветТЗ.СуммаЗаказа КАК СуммаЗаказа,
                                  | ОтветТЗ.УИД КАК УИД
                                  |ПОМЕСТИТЬ ВТ
                                  |ИЗ
                                  | &ОтветТЗ КАК ОтветТЗ
                                  |;
                                  |
                                  |////////////////////////////////////////////////////////////////////////////////
                                  |ВЫБРАТЬ
                                  | ВТ.Товар КАК Товар,
                                  | ВТ.Количество КАК Количество,
                                  | ВТ.Номер КАК Номер,
                                  | ВТ.Дата КАК Дата,
                                  | ВТ.Клиент КАК Клиент,
                                  | ВТ.АдресДоставки КАК АдресДоставки,
                                  | ВТ.СуммаЗаказа КАК СуммаЗаказа,
                                  | ВТ.УИД КАК УИД
                                  |ИЗ
                                  | ВТ КАК ВТ
                                  |ИТОГИ ПО
                                  | УИД";
            ЗапросОтветТЗ.УстановитьПараметр("ОтветТЗ", ОтветТЗ.Ответ);
            ВыборкаУИД = ЗапросОтветТЗ.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
            Пока ВыборкаУИД.Следующий() Цикл
                
                ДокДоставка = Документы.Доставка.ПолучитьСсылку(ВыборкаУИД.УИД);
                Если ДокДоставка = Документы.Доставка.ПустаяСсылка() Или СтрНайти(Строка(ДокДоставка), "Объект не найден")>0 Тогда
                    
                    НовДоставка = Документы.Доставка.СоздатьДокумент();
                    Ссылка = Документы.Доставка.ПолучитьСсылку(ВыборкаУИД.УИД);
                    НовДоставка.УстановитьСсылкуНового(Ссылка);
                    
                    
                    Выборка = ВыборкаУИД.Выбрать();
                    Пока Выборка.Следующий() Цикл
                        
                        НовДоставка.Дата = Выборка.Дата;
                        НовДоставка.Клиент = Выборка.Клиент;
                        НовДоставка.АдресДоставки = Выборка.АдресДоставки;
                        НовДоставка.СуммаЗаказа = Выборка.СуммаЗаказа;
                        СтрТЧ = НовДоставка.Товары.Добавить();
                        СтрТЧ.Товар = Выборка.Товар;
                        СтрТЧ.Количество = Выборка.Количество;
                        
                    КонецЦикла;
                    НовДоставка.Записать(РежимЗаписиДокумента.Запись);
                
                КонецЕсли;  
                                
            КонецЦикла;
            Сообщить("Загружены новые документы");
            
        Исключение
            
            Сообщить(ОписаниеОшибки());
        КонецПопытки;

КонецПроцедуры
========================================================================================
Доставка:
Клиент
АдресДоставки
СуммаЗаказа
Доставлен
ТЧ:
Товары
Количество

</h1>
</body>
</html>